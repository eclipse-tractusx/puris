meta {
  name: 01-Identify own catalog entries
  type: http
  seq: 1
  tags: [
    admin
  ]
}

post {
  url: {{CUSTOMER_EDC}}/{{MANAGEMENT_PATH}}/v3/catalog/request
  body: json
  auth: apikey
}

auth:apikey {
  key: X-API-KEY
  value: {{CUSTOMER_EDC_API_KEY}}
  placement: header
}

body:json {
  {
    "@context": {
      "@vocab": "https://w3id.org/edc/v0.0.1/ns/"
    },
    "@type": "CatalogRequest",
    "protocol": "dataspace-protocol-http",
    "counterPartyAddress": "{{CUSTOMER_EDC_EXT_HOSTNAME}}/{{PROTOCOL_PATH}}",
    "counterPartyId": "{{CUSTOMER_BPNL}}",
    "querySpec": {
      "offset": 0,
      "limit": 100,
      "filter": "",
      "range": {
        "from": 0,
        "to": 100
      },
      "filterExpression": [
        {
          "@type": "CriterionDto",
          "operandLeft": "https://w3id.org/catenax/ontology/common#version",
          "operator": "=",
          "operandRight": "3.0"
        },
        {
          "@type": "CriterionDto",
          "operandLeft": "'http://purl.org/dc/terms/type'.'@id'",
          "operator": "=",
          "operandRight": "https://w3id.org/catenax/taxonomy#DigitalTwinRegistry"
        }
      ]
    }
  }
}

tests {
  let jsonData = res.getBody();
  
  let catalog = jsonData['dcat:dataset'];
  
  let offer = catalog["odrl:hasPolicy"]
  const offerId = offer["@id"]
  const assetId = catalog['id']
  
  const [encodedContractDefintionId] = offerId.split(':')
  console.log(encodedContractDefintionId)
  var contractDefinitionId = Buffer.from(encodedContractDefintionId, 'base64').toString("utf-8");
  
  bru.setVar("DTR_CATALOG_OFFER_CONTRACT_DEFINITION_ID", contractDefinitionId)
  bru.setVar("DTR_CATALOG_OFFER_ASSET_ID", assetId)
}
